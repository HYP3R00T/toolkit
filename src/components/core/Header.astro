---
import { Icon } from "astro-icon/components";
import { Button } from "@/components/ui/button";
import ThemeToggle from "@/components/core/ThemeToggle.astro";
import { Separator } from "@/components/ui/separator";
import { SITE, Socials, navItems } from "@data/config";
import {
    getRepoStarCount,
    formatStarCount,
    shouldShowStarCount,
} from "@/lib/github";

const starCount = await getRepoStarCount(SITE.repo);
const showStarCount = shouldShowStarCount(starCount, SITE.starCountThreshold);
const formattedStarCount = showStarCount ? formatStarCount(starCount) : "";
const menuButtonId = "mobile-menu-btn";
const menuPanelId = "mobile-menu";
const activeSocials = Socials.filter((social) => social.active);
---

<header
    class="sticky top-0 z-50 w-full border-b border-border/40 bg-background/95 backdrop-blur-sm supports-backdrop-filter:bg-background/60"
>
    <div id="header-inner" class="w-full flex items-center px-4 py-3 md:py-4">
        <div class="flex items-center gap-6">
            <Button variant="ghost" size="icon">
                <a href="/" class="flex items-center gap-2" aria-label="Home">
                    <Icon name="logo" class="size-5" />
                </a>
            </Button>
        </div>

        <div class="ml-auto flex items-center gap-2 lg:h-4">
            <Separator orientation="vertical" className="hidden lg:block" />
            <Button
                variant="ghost"
                size={showStarCount ? "default" : "icon"}
                className={showStarCount ? "gap-2" : ""}
                aria-label="GitHub repository"
            >
                <a
                    href={SITE.repo}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex gap-2 items-center"
                >
                    <Icon name="github" class="size-5" />
                    {
                        showStarCount && (
                            <span class="text-xs font-medium text-muted-foreground">
                                {formattedStarCount}
                            </span>
                        )
                    }
                </a>
            </Button>
            <Separator orientation="vertical" className="hidden lg:block" />
            <Button
                id="header-width-toggle"
                variant="ghost"
                size="icon"
                className="hidden md:inline-flex"
                aria-label="Toggle header width"
                aria-pressed="false"
                title="Full"
            >
                <Icon name="spacing" class="size-5" aria-hidden="true" />
            </Button>
            <Separator orientation="vertical" className="hidden lg:block" />
            <ThemeToggle />

            <Button
                id={menuButtonId}
                className="md:hidden"
                variant="ghost"
                size="icon"
                aria-expanded={"false"}
                aria-controls={menuPanelId}
                aria-label="Toggle navigation menu"
                data-state="closed"
            >
                <Icon data-icon="menu" name="menu" class="size-5" />
                <Icon data-icon="close" name="close" class="size-5 hidden" />
            </Button>
        </div>
    </div>
</header>

<div
    id={menuPanelId}
    class="fixed inset-0 z-40 hidden md:hidden bg-background/80 backdrop-blur-sm supports-backdrop-filter:bg-background/60"
    aria-hidden="true"
>
    <div class="flex h-full w-full flex-col px-4 pb-4 pt-19 overflow-hidden">
        <div
            class="mx-auto w-full max-w-md rounded-lg border border-border/50 bg-linear-to-b from-background/85 via-background/95 to-background/98 shadow-xl max-h-[calc(100vh-5.5rem)] overflow-y-auto"
        >
            <div class="flex flex-col gap-6 px-6 py-6">
                <nav
                    class="flex flex-col items-center gap-3 text-sm font-medium"
                >
                    {
                        navItems.map(({ href, label, special, blank }) => (
                            <a
                                href={href}
                                target={blank ? "_blank" : undefined}
                                rel={blank ? "noreferrer" : undefined}
                                class={`tracking-wide transition hover:text-primary ${special ? "text-primary" : "text-muted-foreground"}`}
                            >
                                {label}
                            </a>
                        ))
                    }
                </nav>

                <div
                    class="flex items-center justify-center gap-3 border-t border-border/40 pt-4"
                >
                    {
                        activeSocials.map(({ name, href, linkTitle }) => (
                            <Button
                                key={name}
                                variant="ghost"
                                size="icon"
                                asChild
                            >
                                <a
                                    href={href}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    aria-label={linkTitle ?? name}
                                >
                                    <Icon name={name} class="size-5" />
                                </a>
                            </Button>
                        ))
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("astro:page-load", () => {
        const menuButtonId = "mobile-menu-btn";
        const menuPanelId = "mobile-menu";
        const menuBtn = document.getElementById(menuButtonId);
        const mobileMenu = document.getElementById(menuPanelId);
        const menuIcon = menuBtn?.querySelector('[data-icon="menu"]');
        const closeIcon = menuBtn?.querySelector('[data-icon="close"]');

        if (!menuBtn || !mobileMenu) {
            return;
        }

        const setMenuState = (isOpen: boolean) => {
            mobileMenu.classList.toggle("hidden", !isOpen);
            menuBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
            mobileMenu.setAttribute("aria-hidden", isOpen ? "false" : "true");
            menuBtn.setAttribute("data-state", isOpen ? "open" : "closed");
            menuIcon?.classList.toggle("hidden", isOpen);
            closeIcon?.classList.toggle("hidden", !isOpen);
            document.body.style.overflow = isOpen ? "hidden" : "";
        };

        const toggleMenu = () => {
            const isOpen = !mobileMenu.classList.contains("hidden");
            setMenuState(!isOpen);
        };

        menuBtn.addEventListener("click", toggleMenu);

        mobileMenu.querySelectorAll("a").forEach((link) => {
            link.addEventListener("click", () => setMenuState(false));
        });

        mobileMenu.addEventListener("click", (event) => {
            if (event.target === mobileMenu) {
                setMenuState(false);
            }
        });

        window.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                setMenuState(false);
            }
        });

        // Header width toggle
        const layoutStorageKey = "header-width-mode";
        const headerInner = document.getElementById("header-inner");
        const headerToggle = document.getElementById("header-width-toggle");
        // no textual label â€” we use a simple icon and toggle the button's title instead

        const applyHeaderMode = (mode: string) => {
            if (!headerInner || !headerToggle) return;
            const isNarrow = mode === "narrow";
            headerToggle.setAttribute(
                "aria-pressed",
                isNarrow ? "true" : "false",
            );
            headerToggle.setAttribute("title", isNarrow ? "Narrow" : "Full");
            if (isNarrow) {
                headerInner.classList.add("max-w-7xl", "mx-auto");
            } else {
                headerInner.classList.remove("max-w-7xl", "mx-auto");
            }
            localStorage.setItem(
                layoutStorageKey,
                isNarrow ? "narrow" : "full",
            );
        };

        const saved = localStorage.getItem(layoutStorageKey);
        applyHeaderMode(saved === "narrow" ? "narrow" : "full");

        headerToggle?.addEventListener("click", () => {
            const current =
                headerToggle.getAttribute("aria-pressed") === "true"
                    ? "narrow"
                    : "full";
            const next = current === "narrow" ? "full" : "narrow";
            applyHeaderMode(next);
        });
    });
</script>
